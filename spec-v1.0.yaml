openapi: 3.0.2
info:
  title: NADA
  version: "1.0"
servers:
  - url: "https://localhost:8080/api"
  - url: "https://nada.dev.intern.nav.no/api"
  - url: "https://nada.intern.nav.no/api"

components:
  securitySchemes:
    cookieAuth:
      type: token
      in: cookie
      name: jwt
  schemas:
    Dataproduct:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        slug:
          type: string
        repo:
          type: string
        last_modified:
          type: string
          format: date-time
        created:
          type: string
          format: date-time
        owner:
          $ref: "#/components/schemas/Owner"
        keywords:
          type: array
          items:
            type: string
        datasets:
          type: array
          items:
            $ref: "#/components/schemas/DatasetSummary"
      required:
        - id
        - name
        - slug
        - owner
        - created
        - last_modified
        - datasets

    DatasetSummary:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        type:
          $ref: "#/components/schemas/DatasetType"
      required:
        - id
        - name
        - type

    DatasetType:
      type: string
      enum:
        - bigquery

    Owner:
      type: object
      properties:
        team:
          type: string
        teamkatalogen:
          type: string
      required:
        - team

    BigQuery:
      type: object
      properties:
        project_id:
          type: string
        dataset:
          type: string
        table:
          type: string
      required:
        - project_id
        - dataset
        - table

    NewDataproduct:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        slug:
          type: string
        repo:
          type: string
        owner:
          $ref: "#/components/schemas/Owner"
        keywords:
          type: array
          items:
            type: string
      required:
        - name
        - owner

    UpdateDataproduct:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        slug:
          type: string
        repo:
          type: string
        keywords:
          type: array
          items:
            type: string
      required:
        - name

    UserInfo:
      type: object
      properties:
        name:
          type: string
        email:
          type: string
        teams:
          type: array
          items:
            type: string
      required:
        - name
        - email
        - teams

    Dataset:
      type: object
      properties:
        id:
          type: string
        dataproduct_id:
          type: string
        name:
          type: string
        description:
          type: string
        pii:
          type: boolean
        type:
          $ref: "#/components/schemas/DatasetType"
        bigquery:
          $ref: "#/components/schemas/BigQuery"
      required:
        - id
        - name
        - type
        - pii
        - dataproduct_id
        - bigquery

    NewDataset:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        dataproduct_id:
          type: string
        pii:
          type: boolean
        bigquery:
          $ref: "#/components/schemas/BigQuery"
      required:
        - name
        - dataproduct_id
        - pii
        - bigquery # Update this to a oneOf when we have more than bigquery

    TableColumn:
      type: object
      properties:
        name:
          type: string
        type:
          type: string
        mode:
          type: string
        description:
          type: string
      required:
        - name
        - type
        - mode
        - description

    DatasetMetadata:
      type: object
      properties:
        id:
          type: string
        dataset_id:
          type: string
        schema:
          type: array
          items:
            $ref: "#/components/schemas/TableColumn"
      required:
        - id
        - dataset_id
        - schema

    SearchResultEntry:
      type: object
      properties:
        url:
          type: string
        type:
          $ref: "#/components/schemas/SearchResultType"
        id:
          type: string
        name:
          type: string
        excerpt:
          type: string
      required:
        - url
        - type
        - id
        - name
        - excerpt

    SearchResultType:
      type: string
      enum:
        - dataset
        - dataproduct
        - datapackage

paths:
  /userinfo:
    get:
      security:
        - cookieAuth: []
      description: "get user info"
      operationId: "getUserInfo"
      responses:
        "200":
          description: OK
          content:
            "application/json":
              schema:
                $ref: "#/components/schemas/UserInfo"

  /dataproducts:
    get:
      description: "List all dataproducts"
      operationId: "getDataproducts"
      parameters:
        - in: "query"
          name: "limit"
          schema:
            type: "integer"
            default: 15
        - in: "query"
          name: "offset"
          schema:
            type: "integer"
            default: 0
      responses:
        "200":
          description: OK
          content:
            "application/json":
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Dataproduct"
    post:
      security:
        - cookieAuth: []
      description: "Create a new dataproduct"
      operationId: "createDataproduct"
      requestBody:
        content:
          "application/json":
            schema:
              $ref: "#/components/schemas/NewDataproduct"
      responses:
        "201":
          description: "Created successfully"
          content:
            "application/json":
              schema:
                $ref: "#/components/schemas/Dataproduct"

  /dataproducts/{id}:
    get:
      description: "List a dataproduct with datasets"
      operationId: "getDataproduct"
      parameters:
        - in: path
          name: id
          description: Dataproduct ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            "application/json":
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Dataproduct"
    delete:
      security:
        - cookieAuth: []
      description: "Delete a dataproduct"
      operationId: "deleteDataproduct"
      parameters:
        - in: path
          name: id
          description: Dataproduct ID
          required: true
          schema:
            type: string
      responses:
        "204":
          description: "Deleted OK"
    put:
      security:
        - cookieAuth: []
      description: "Update a dataproduct"
      operationId: "updateDataproduct"
      parameters:
        - in: path
          name: id
          description: Dataproduct ID
          required: true
          schema:
            type: string
      requestBody:
        content:
          "application/json":
            schema:
              $ref: "#/components/schemas/UpdateDataproduct"
      responses:
        "200":
          description: "Updated OK"
          content:
            "application/json":
              schema:
                $ref: "#/components/schemas/Dataproduct"

  /datasets:
    post:
      security:
        - cookieAuth: []
      description: "Create a new dataset"
      operationId: "createDataset"
      requestBody:
        content:
          "application/json":
            schema:
              $ref: "#/components/schemas/NewDataset"
      responses:
        "201":
          description: "Created successfully"
          content:
            "application/json":
              schema:
                $ref: "#/components/schemas/Dataset"

  /datasets/{id}:
    get:
      description: "Get dataset"
      operationId: "getDataset"
      parameters:
        - in: path
          name: id
          description: Dataset ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            "application/json":
              schema:
                $ref: "#/components/schemas/Dataset"
    put:
      security:
        - cookieAuth: []
      description: "Update a dataset"
      operationId: "updateDataset"
      parameters:
        - in: path
          name: id
          description: Dataset ID
          required: true
          schema:
            type: string
      requestBody:
        content:
          "application/json":
            schema:
              $ref: "#/components/schemas/NewDataset"
      responses:
        "200":
          description: "Updated OK"
          content:
            "application/json":
              schema:
                $ref: "#/components/schemas/Dataset"
    delete:
      security:
        - cookieAuth: []
      description: "Delete a dataset"
      operationId: "deleteDataset"
      parameters:
        - in: path
          name: id
          description: Dataset ID
          required: true
          schema:
            type: string
      responses:
        "204":
          description: "Deleted OK"

  /datasets/{id}/metadata:
    get:
      description: "Get dataset metadata"
      operationId: "getDatasetMetadata"
      parameters:
        - in: path
          name: id
          description: Dataset ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            "application/json":
              schema:
                $ref: "#/components/schemas/DatasetMetadata"

  /search:
    parameters:
      - in: query
        name: q
        schema:
          type: string
      - in: "query"
        name: "limit"
        schema:
          type: "integer"
          default: 15
      - in: "query"
        name: "offset"
        schema:
          type: "integer"
          default: 0

    get:
      description: "Search in NADA"
      operationId: "search"
      responses:
        "200":
          description: Search result
          content:
            "application/json":
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SearchResultEntry"
